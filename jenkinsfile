pipeline {
 environment {
    		DOCKERHUB_CREDENTIALS=credentials('docker')
        SCANNER_HOME = tool 'sonar-scanner'

      
    	}
    agent any
stages{

         stage("clean up")
{  steps{
       deleteDir()

}}
stage("chekout"){

  steps { git url: 'https://github.com/nourchawebi/astonvilla.git'}

}
stage("generate docker image")
{
steps { sh "docker build -t nourchawebi/astonvilla-app:1.1.${env.BUILD_NUMBER} ." }
}
 //   stage('Docker Image Scan') {
        //    steps {
        //        sh "trivy image --format table -o trivy-image-report.html nourchawebi/astonvilla:1.1.${env.BUILD_NUMBER} "
       //     }
    //    }
        
stage ("login")
{
	steps {	sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
	}
}
stage ("push")
{
steps{
 sh " docker push  nourchawebi/astonvilla-app:1.1.${env.BUILD_NUMBER}"
}

}
//stage('File System Scan') {
          //  steps {
           //     sh "trivy fs --format table -o trivy-fs-report.html ."
         //   }
    //    }
//   stage('OWASP SCAN') {
  //  steps {
      //  dependencyCheck additionalArguments: '', odcInstallation: 'DP-CHECK'
      //  dependencyCheckPublisher pattern: '**/dependency-check-report.xml'
   // }
//}
  
//stage('SonarQube Analysis') {
          //  steps {
             // withCredentials([ string(credentialsId: 'sonarqube-url', variable: 'SONARQUBE_HOST_URL'), 
//string(credentialsId: 'sonarqube-login', variable: 'SONARQUBE_LOGIN') ]) { 
                //    sh '''$SCANNER_HOME/bin/sonar-scanner \
                     //   -Dsonar.host.url=${SONARQUBE_HOST_URL} \
                     //   -Dsonar.token=${SONARQUBE_LOGIN} \
                     //   -Dsonar.projectName=astonvillaJenkins \
                     //   -Dsonar.java.binaries=. \
                     //   -Dsonar.projectKey=astonvillaJenkins '''   }
                
          //  }
     //   }

// stage('Quality Gate') {
          //  steps {
             //   script {
                  waitForQualityGate abortPipeline: false, credentialsId: 'sonarqube-login' 
             //   }
           // }
      //  }
        
}}
// pipeline {
//     agent any
//     stages {
//         stage('Greetingg') {
//             steps {
//                 sh 'echo "Hello we are creating a pipeline for astonvilla App!"'
//             }
//         }
//     }
// }

